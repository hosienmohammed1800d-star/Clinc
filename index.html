<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مخزن د. ثائر - سحابي</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous"></script>

  <!-- Excel + Sort -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" crossorigin="anonymous"></script>

  <!-- ✅ Fix: hoisted $ + runAfterDom (prevents "$ before init" forever) -->
  <script>
    function $(id){ return document.getElementById(id); }
    window.__runAfterDom = function(fn){
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", fn, { once:true });
      } else {
        fn();
      }
    };
  </script>

  <style>
    body { font-family: system-ui,-apple-system,"Segoe UI",Tahoma; margin:0; }
    .glass { background: rgba(30, 41, 59, 0.65); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
    input, select {
      background: rgba(15,23,42,0.6)!important;
      border: 1px solid rgba(255,255,255,0.10)!important;
      color: #fff!important;
    }
    input:focus, select:focus { outline:none; border-color: var(--accent, #3b82f6)!important; background: rgba(30,41,59,0.9)!important; }
    th { background:#1e293b!important; color:#94a3b8!important; white-space:nowrap; font-size:0.8rem; }
    .handle { cursor: grab; color:#64748b; padding: 10px; }
    .status-online { color:#10b981; }
    .status-offline { color:#f87171; font-weight:700; }
    .status-connecting { color:#fbbf24; }

    @media (max-width: 768px) {
      .table-container { font-size: 13px; }
      input.table-input { width: 64px !important; padding: 4px !important; font-size: 12px; }
      .name-input { width: 120px !important; }
      .desc-input { width: 140px !important; }
    }
  </style>
</head>

<body class="min-h-screen" style="background:#0f172a;color:#e2e8f0;">
  <div class="max-w-7xl mx-auto p-4 md:p-6">

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
      <div class="flex items-center gap-4 w-full md:w-auto">
        <div class="w-12 h-12 rounded-xl flex items-center justify-center shadow-lg" style="background:var(--accent,#3b82f6)">
          <i class="fas fa-cloud text-2xl text-white"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold" id="appTitle">مخزن د. ثائر السحابي</h1>
          <div class="flex items-center gap-2 text-xs">
            <span id="syncStatus" class="status-connecting">
              <i class="fas fa-circle text-[8px]"></i> جاري الاتصال...
            </span>
            <span class="text-slate-500">|</span>
            <span id="userDisplay" class="text-slate-400 italic">...</span>
          </div>
        </div>
      </div>

      <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
        <button onclick="downloadAppFile()" class="text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm whitespace-nowrap shadow-lg transition-all active:scale-95" style="background:var(--accent,#3b82f6)">
          <i class="fas fa-download"></i> <span id="btnDownloadTxt">تحميل النظام (HTML)</span>
        </button>
        <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm whitespace-nowrap shadow-lg">
          <i class="fas fa-file-excel"></i> <span id="btnExportTxt">تصدير إكسل</span>
        </button>
      </div>
    </header>

    <!-- Settings Panel -->
    <div class="glass rounded-xl p-4 mb-6">
      <div class="flex flex-col md:flex-row gap-3 items-start md:items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="fas fa-sliders text-slate-300"></i>
          <h2 class="font-bold">الإعدادات</h2>
        </div>

        <div class="flex flex-wrap gap-2 items-center">
          <select id="themeSelect" class="p-2 rounded-lg text-sm">
            <option value="midnight">Midnight</option>
            <option value="slate">Slate</option>
            <option value="ivory">Ivory</option>
            <option value="ocean">Ocean</option>
            <option value="berry">Berry</option>
          </select>

          <button id="saveUiBtn" class="bg-slate-100 hover:bg-white text-slate-900 px-4 py-2 rounded-lg text-sm font-bold">
            حفظ الإعدادات
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
        <input id="txtTitle" class="p-2 rounded-lg text-sm" placeholder="عنوان التطبيق" />
        <input id="txtAdd" class="p-2 rounded-lg text-sm" placeholder="نص زر الإضافة" />
        <input id="txtExport" class="p-2 rounded-lg text-sm" placeholder="نص زر التصدير" />
        <input id="txtDownload" class="p-2 rounded-lg text-sm" placeholder="نص زر التحميل" />
      </div>

      <div class="mt-3 flex flex-col md:flex-row gap-2 items-start md:items-center justify-between">
        <div class="text-xs text-slate-400">
          ✅ القراءة للجميع. ✏️ التعديل للأدمن فقط (مع تسجيل دخول).
        </div>

        <div class="flex gap-2 items-center">
          <button id="adminToggleBtn" class="px-4 py-2 rounded-lg text-sm text-white" style="background:var(--accent,#3b82f6)">
            دخول أدمن
          </button>
          <button id="adminLogoutBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm hidden">
            خروج
          </button>
          <span id="adminState" class="text-xs text-slate-300">زائر</span>
        </div>
      </div>

      <div id="adminBox" class="mt-3 hidden grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="adminEmail" class="p-2 rounded-lg text-sm" placeholder="Admin Email" />
        <input id="adminPass" type="password" class="p-2 rounded-lg text-sm" placeholder="Admin Password" />
        <button id="doAdminLogin" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold">
          تسجيل دخول
        </button>
        <div class="md:col-span-3 text-xs text-slate-400">
          الأفضل تسوي حساب أدمن من Firebase Authentication (Email/Password) وتستخدمه هنا.
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
      <div class="glass p-4 rounded-xl">
        <p class="text-slate-400 text-[10px] md:text-xs mb-1">إجمالي القيمة المالية</p>
        <h3 id="totalValue" class="text-sm md:text-lg font-bold text-blue-400">0 د.ع</h3>
      </div>
      <div class="glass p-4 rounded-xl">
        <p class="text-slate-400 text-[10px] md:text-xs mb-1">عدد المواد</p>
        <h3 id="totalItems" class="text-sm md:text-lg font-bold">0</h3>
      </div>
      <div class="glass p-4 rounded-xl border-r-4 border-red-500">
        <p class="text-slate-400 text-[10px] md:text-xs mb-1">نواقص (≤ 2)</p>
        <h3 id="lowStockCount" class="text-sm md:text-lg font-bold text-red-400">0</h3>
      </div>
      <div class="glass p-4 rounded-xl border-r-4 border-emerald-500">
        <p class="text-slate-400 text-[10px] md:text-xs mb-1">إجمالي المصروف</p>
        <h3 id="totalSpent" class="text-sm md:text-lg font-bold text-emerald-400">0</h3>
      </div>
    </div>

    <!-- Add -->
    <div class="glass p-4 rounded-xl mb-6">
      <form id="addForm" class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <div class="col-span-2 md:col-span-1">
          <input type="text" id="name" class="w-full p-2 rounded-lg text-sm" placeholder="المادة..." required />
        </div>

        <div class="col-span-2 md:col-span-2">
          <input type="text" id="desc" class="w-full p-2 rounded-lg text-sm" placeholder="الوصف..." />
        </div>

        <div>
          <input type="number" id="start" class="w-full p-2 rounded-lg text-sm" placeholder="البداية" step="any" />
        </div>

        <div>
          <input type="number" id="cost" class="w-full p-2 rounded-lg text-sm" placeholder="سعر CC" step="any" />
        </div>

        <div class="col-span-2 md:col-span-5">
          <button type="submit" id="addBtn" class="w-full bg-slate-100 hover:bg-white text-slate-900 py-2 rounded-lg font-bold text-sm shadow-lg active:scale-95 transition-all">
            إضافة مادة <i class="fas fa-plus mr-1"></i>
          </button>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="glass rounded-xl overflow-hidden shadow-2xl">
      <div class="overflow-x-auto table-container">
        <table class="w-full text-right border-collapse">
          <thead>
            <tr class="border-b border-slate-700">
              <th class="p-3 text-center w-8">#</th>
              <th class="p-3">المادة</th>
              <th class="p-3">الوصف</th>
              <th class="p-3 text-center text-emerald-300">البداية</th>
              <th class="p-3 text-center text-sky-300">مشتريات</th>
              <th class="p-3 text-center text-orange-300">مصروف</th>
              <th class="p-3 text-center">المتبقي</th>
              <th class="p-3 text-center">سعر CC</th>
              <th class="p-3 text-center">القيمة الإجمالية</th>
              <th class="p-3 text-center">الحالة</th>
              <th class="p-3 text-center">حذف</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInAnonymously,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      onSnapshot,
      query,
      writeBatch,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // ✅ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC_KaWOZVWJ5WvVhUjiz58dx6d6sWH1EZQ",
      authDomain: "clinic-storage.firebaseapp.com",
      projectId: "clinic-storage",
      storageBucket: "clinic-storage.firebasestorage.app",
      messagingSenderId: "284636281654",
      appId: "1:284636281654:web:aa19cd577c4efda5d21197"
    };

    const appId = "clinic-storage";

    // ========= UI Settings =========
    const THEMES = {
      midnight: { bg: "#0f172a", accent: "#3b82f6", card: "rgba(30,41,59,0.65)", text:"#e2e8f0" },
      slate:    { bg: "#0b1220", accent: "#22c55e", card: "rgba(15,23,42,0.70)", text:"#e2e8f0" },
      ivory:    { bg: "#f8fafc", accent: "#2563eb", card: "rgba(255,255,255,0.82)", text:"#0f172a" },
      ocean:    { bg: "#071a2b", accent: "#38bdf8", card: "rgba(56,189,248,0.10)", text:"#e2e8f0" },
      berry:    { bg: "#160b1f", accent: "#a78bfa", card: "rgba(167,139,250,0.10)", text:"#e2e8f0" }
    };

    const DEFAULT_TEXTS = {
      appTitle: "مخزن د. ثائر السحابي",
      addButton: "إضافة مادة",
      exportButton: "تصدير إكسل",
      downloadButton: "تحميل النظام (HTML)"
    };

    const LOCAL_KEY = "clinic_ui_settings_v2";

    function getLocalSettings(){
      try {
        return JSON.parse(localStorage.getItem(LOCAL_KEY) || "null") || { theme:"midnight", texts:{...DEFAULT_TEXTS} };
      } catch {
        return { theme:"midnight", texts:{...DEFAULT_TEXTS} };
      }
    }
    function saveLocalSettings(s){ localStorage.setItem(LOCAL_KEY, JSON.stringify(s)); }

    function applyTheme(themeId){
      const t = THEMES[themeId] || THEMES.midnight;
      document.body.style.background = t.bg;
      document.body.style.color = t.text;
      document.documentElement.style.setProperty("--accent", t.accent);

      document.querySelectorAll(".glass").forEach(el=>{
        el.style.background = t.card;
        el.style.borderColor = "rgba(255,255,255,0.08)";
      });
    }

    function applyTexts(texts){
      $("appTitle").textContent = texts.appTitle || DEFAULT_TEXTS.appTitle;
      $("btnDownloadTxt").textContent = texts.downloadButton || DEFAULT_TEXTS.downloadButton;
      $("btnExportTxt").textContent = texts.exportButton || DEFAULT_TEXTS.exportButton;
      $("addBtn").innerHTML = `${texts.addButton || DEFAULT_TEXTS.addButton} <i class="fas fa-plus mr-1"></i>`;
    }

    function applyLocalSettings(){
      const s = getLocalSettings();
      applyTheme(s.theme);
      applyTexts(s.texts);

      $("themeSelect").value = s.theme;
      $("txtTitle").value = s.texts.appTitle || "";
      $("txtAdd").value = s.texts.addButton || "";
      $("txtExport").value = s.texts.exportButton || "";
      $("txtDownload").value = s.texts.downloadButton || "";
    }

    // ========= Firebase =========
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let inventory = [];
    let sortableInited = false;
    let isAdmin = false;

    const esc = (v) => String(v ?? "").replace(/"/g, "&quot;");

    function invCol(){
      return collection(db, "artifacts", appId, "public", "data", "inventory");
    }

    function setStatus(cls, htmlOrText){
      const s = $("syncStatus");
      s.className = cls;
      if (htmlOrText.includes("<")) s.innerHTML = htmlOrText;
      else s.textContent = htmlOrText;
    }

    function setAdminUI(state, email=""){
      isAdmin = state;

      $("adminState").textContent = state ? `أدمن: ${email || ""}` : "زائر";
      $("adminLogoutBtn").classList.toggle("hidden", !state);

      // disable edits if not admin
      document.querySelectorAll("#tableBody input, #addForm input, #addForm button[type='submit']").forEach(el=>{
        el.disabled = !isAdmin;
        el.style.opacity = isAdmin ? "1" : "0.75";
      });
      document.querySelectorAll("#tableBody button").forEach(btn=>{
        btn.disabled = !isAdmin;
        btn.style.opacity = isAdmin ? "1" : "0.5";
        btn.style.pointerEvents = isAdmin ? "auto" : "none";
      });
    }

    // ========= UI events =========
    $("themeSelect").addEventListener("change", ()=>{
      const s = getLocalSettings();
      s.theme = $("themeSelect").value;
      saveLocalSettings(s);
      applyLocalSettings();
    });

    $("saveUiBtn").addEventListener("click", ()=>{
      const s = getLocalSettings();
      s.texts = {
        appTitle: $("txtTitle").value.trim() || DEFAULT_TEXTS.appTitle,
        addButton: $("txtAdd").value.trim() || DEFAULT_TEXTS.addButton,
        exportButton: $("txtExport").value.trim() || DEFAULT_TEXTS.exportButton,
        downloadButton: $("txtDownload").value.trim() || DEFAULT_TEXTS.downloadButton
      };
      saveLocalSettings(s);
      applyLocalSettings();
    });

    $("adminToggleBtn").addEventListener("click", ()=>{
      $("adminBox").classList.toggle("hidden");
      $("adminBox").classList.toggle("grid");
    });

    $("doAdminLogin").addEventListener("click", async ()=>{
      const email = $("adminEmail").value.trim();
      const pass  = $("adminPass").value.trim();
      if (!email || !pass) return alert("اكتب الإيميل والباسورد");
      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        setAdminUI(true, cred.user.email || "");
      } catch (e) {
        console.error(e);
        alert("فشل تسجيل دخول الأدمن");
      }
    });

    $("adminLogoutBtn").addEventListener("click", async ()=>{
      await signOut(auth);
    });

    // ========= Realtime =========
    function startRealtime(){
      const q = query(invCol());
      onSnapshot(q, (snap)=>{
        inventory = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(a.order||0)-(b.order||0));
        renderTable();
      }, (err)=>{
        console.error(err);
        setStatus("status-offline", "فشل الاتصال: " + (err?.code || err?.message || "Firestore error"));
      });
    }

    window.updateField = async (id, field, value)=>{
      if (!isAdmin) return alert("التعديل للأدمن فقط");
      const isText = field === "name" || field === "desc";
      const val = isText ? (value ?? "") : (parseFloat(value) || 0);

      await updateDoc(doc(db, "artifacts", appId, "public", "data", "inventory", id), {
        [field]: val,
        updatedAt: serverTimestamp()
      });
    };

    window.deleteItem = async (id)=>{
      if (!isAdmin) return alert("الحذف للأدمن فقط");
      if (!confirm("حذف نهائي؟")) return;
      await deleteDoc(doc(db, "artifacts", appId, "public", "data", "inventory", id));
    };

    $("addForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!isAdmin) return alert("الإضافة للأدمن فقط");

      const name = $("name").value.trim();
      const desc = $("desc").value.trim();
      const start = parseFloat($("start").value) || 0;
      const cost  = parseFloat($("cost").value) || 0;

      if (!name) return;

      await addDoc(invCol(), {
        name, desc,
        start,
        bought: 0,
        spent: 0,
        cost,
        order: inventory.length,
        createdAt: Date.now(),
        updatedAt: serverTimestamp()
      });

      e.target.reset();
    });

    function renderTable(){
      const body = $("tableBody");
      body.innerHTML = "";

      let totalVal = 0, totalSpent = 0, low = 0;

      inventory.forEach((item)=>{
        const start = Number(item.start)||0;
        const bought = Number(item.bought)||0;
        const spent = Number(item.spent)||0;
        const cost = Number(item.cost)||0;

        const remaining = (start + bought) - spent;
        const rowValue = remaining * cost;

        totalVal += rowValue;
        totalSpent += spent;
        if (remaining <= 2) low++;

        const statusText = remaining <= 2 ? "نقص" : "متوفر";
        const statusClass = remaining <= 2 ? "text-red-400 font-bold" : "text-emerald-400 font-bold";

        const tr = document.createElement("tr");
        tr.className = "border-b border-slate-800 hover:bg-slate-800/40 transition-colors";
        tr.setAttribute("data-id", item.id);

        tr.innerHTML = `
          <td class="p-2 text-center"><i class="fas fa-grip-vertical handle"></i></td>

          <td class="p-2">
            <input ${isAdmin?"":"disabled"} type="text" value="${esc(item.name)}"
              onblur="updateField('${item.id}','name',this.value)"
              class="name-input w-full bg-transparent border-none focus:ring-1 focus:ring-blue-500 font-bold rounded px-2">
          </td>

          <td class="p-2">
            <input ${isAdmin?"":"disabled"} type="text" value="${esc(item.desc)}"
              onblur="updateField('${item.id}','desc',this.value)"
              class="desc-input w-full bg-transparent border-none focus:ring-1 focus:ring-blue-500 rounded px-2">
          </td>

          <td class="p-2 text-center">
            <input ${isAdmin?"":"disabled"} type="number" step="any" value="${start}"
              onchange="updateField('${item.id}','start',this.value)"
              class="table-input w-20 p-1 rounded text-center font-bold
                     text-emerald-300 bg-emerald-500/10 border border-emerald-500/30">
          </td>

          <td class="p-2 text-center">
            <input ${isAdmin?"":"disabled"} type="number" step="any" value="${bought}"
              onchange="updateField('${item.id}','bought',this.value)"
              class="table-input w-20 p-1 rounded text-center font-bold
                     text-sky-300 bg-sky-500/10 border border-sky-500/30">
          </td>

          <td class="p-2 text-center">
            <input ${isAdmin?"":"disabled"} type="number" step="any" value="${spent}"
              onchange="updateField('${item.id}','spent',this.value)"
              class="table-input w-20 p-1 rounded text-center font-bold
                     text-orange-300 bg-orange-500/10 border border-orange-500/30">
          </td>

          <td class="p-2 text-center font-bold ${remaining<=2?"text-red-400":"text-slate-200"}">${remaining}</td>

          <td class="p-2 text-center">
            <input ${isAdmin?"":"disabled"} type="number" step="any" value="${cost}"
              onchange="updateField('${item.id}','cost',this.value)"
              class="table-input w-24 p-1 rounded text-center">
          </td>

          <td class="p-2 text-center font-bold text-blue-400 text-xs">${Number.isFinite(rowValue)?rowValue.toLocaleString():"0"}</td>

          <td class="p-2 text-center ${statusClass}">${statusText}</td>

          <td class="p-2 text-center">
            <button ${isAdmin?"":"disabled"} onclick="deleteItem('${item.id}')"
              class="text-slate-500 hover:text-red-500 transition-colors">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        body.appendChild(tr);
      });

      $("totalValue").innerText = totalVal.toLocaleString() + " د.ع";
      $("totalItems").innerText = inventory.length;
      $("lowStockCount").innerText = low;
      $("totalSpent").innerText = totalSpent;

      ensureSortable();
    }

    function ensureSortable(){
      if (sortableInited) return;
      if (typeof Sortable === "undefined") return;

      Sortable.create($("tableBody"), {
        handle: ".handle",
        animation: 150,
        onEnd: async ()=>{
          if (!isAdmin) return;
          const batch = writeBatch(db);
          document.querySelectorAll("#tableBody tr").forEach((row, idx)=>{
            const id = row.getAttribute("data-id");
            if (!id) return;
            batch.update(doc(db, "artifacts", appId, "public", "data", "inventory", id), { order: idx });
          });
          await batch.commit();
        }
      });

      sortableInited = true;
    }

    // Download HTML
    window.downloadAppFile = ()=>{
      const content = document.documentElement.outerHTML;
      const blob = new Blob([content], { type:"text/html" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "Clinic_Storage_System.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    // Export Excel
    window.exportToExcel = ()=>{
      if (typeof XLSX === "undefined") return alert("XLSX مو محمّلة");
      const data = inventory.map((i)=>{
        const start = Number(i.start)||0;
        const bought = Number(i.bought)||0;
        const spent = Number(i.spent)||0;
        const cost = Number(i.cost)||0;
        const remaining = (start + bought) - spent;
        return {
          "المادة": i.name || "",
          "الوصف": i.desc || "",
          "البداية": start,
          "مشتريات": bought,
          "مصروف": spent,
          "المتبقي": remaining,
          "سعر CC": cost,
          "القيمة الإجمالية": remaining * cost,
          "الحالة": remaining<=2 ? "نقص" : "متوفر"
        };
      });
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Inventory");
      XLSX.writeFile(wb, `مخزن_د_ثائر_${new Date().toISOString().split("T")[0]}.xlsx`);
    };

    // ========= BOOT =========
    __runAfterDom(async ()=>{
      applyLocalSettings();

      setStatus("status-connecting", `<i class="fas fa-circle text-[8px]"></i> جاري الاتصال...`);

      onAuthStateChanged(auth, async (user)=>{
        // Admin: email/password
        if (user && !user.isAnonymous){
          setStatus("status-online", `<i class="fas fa-circle text-[8px]"></i> متصل سحابياً`);
          $("userDisplay").innerText = `المعرف: ${user.uid.substring(0,8)}`;
          setAdminUI(true, user.email || "");
          startRealtime();
          return;
        }

        // If signed out -> ensure anonymous for viewers
        if (!user){
          try {
            await signInAnonymously(auth);
            return;
          } catch (e){
            console.error(e);
            setStatus("status-offline", "فشل الاتصال: " + (e?.code || e?.message || "Auth error"));
            return;
          }
        }

        // Anonymous viewer
        setStatus("status-online", `<i class="fas fa-circle text-[8px]"></i> متصل سحابياً`);
        $("userDisplay").innerText = `المعرف: ${user.uid.substring(0,8)}`;
        setAdminUI(false);
        startRealtime();
      });
    });
  </script>
</body>
</html>
