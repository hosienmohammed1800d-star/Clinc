<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø®Ø²Ù† Ø¯. Ø«Ø§Ø¦Ø±</title>

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous"></script>

  <!-- Excel + Sort -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel: rgba(17, 24, 39, .72);
      --panelSolid:#111827;
      --border: rgba(255,255,255,.09);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --brand:#3b82f6;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#f87171;

      --start:#34d399;   /* green */
      --buy:#38bdf8;     /* blue */
      --spent:#fb923c;   /* orange */
    }

    /* THEMES (8) */
    [data-theme="midnight"]{ --bg:#0b1220; --panel:rgba(17,24,39,.72); --brand:#3b82f6; }
    [data-theme="arctic"]{ --bg:#071a2b; --panel:rgba(3,18,33,.72); --brand:#22c55e; --muted:#a3c7ff; }
    [data-theme="lavender"]{ --bg:#120b21; --panel:rgba(30,20,50,.72); --brand:#a78bfa; --muted:#cbd5e1; }
    [data-theme="emerald"]{ --bg:#061a14; --panel:rgba(2,24,18,.72); --brand:#10b981; --muted:#a7f3d0; }
    [data-theme="sunset"]{ --bg:#1a0f0b; --panel:rgba(35,18,12,.72); --brand:#fb7185; --muted:#fdba74; }
    [data-theme="slateLight"]{ --bg:#eef2ff; --panel:rgba(255,255,255,.72); --panelSolid:#ffffff; --text:#0f172a; --muted:#475569; --border:rgba(15,23,42,.12); --brand:#2563eb; }
    [data-theme="coffee"]{ --bg:#120f0b; --panel:rgba(33,26,18,.72); --brand:#f59e0b; --muted:#d6d3d1; }
    [data-theme="mono"]{ --bg:#0a0a0a; --panel:rgba(20,20,20,.72); --brand:#ffffff; --muted:#a3a3a3; --border:rgba(255,255,255,.12); }

    body{ background:var(--bg); color:var(--text); margin:0; font-family: system-ui,-apple-system,"Segoe UI",Tahoma; }
    .glass{ background:var(--panel); backdrop-filter: blur(12px); border:1px solid var(--border); }
    .solid{ background:var(--panelSolid); border:1px solid var(--border); }

    input, select{
      background: rgba(0,0,0,.12) !important;
      border: 1px solid var(--border) !important;
      color: var(--text) !important;
      outline: none !important;
    }
    input::placeholder{ color: rgba(148,163,184,.85); }
    input:focus, select:focus{ border-color: var(--brand) !important; box-shadow: 0 0 0 2px rgba(59,130,246,.25); }

    th{
      background: rgba(2,6,23,.45);
      color: var(--muted);
      white-space:nowrap;
      font-size:.82rem;
    }
    .handle{ cursor:grab; opacity:.7; }
    .badge{ border:1px solid var(--border); padding:2px 10px; border-radius:999px; font-size:.75rem; }
    .btn{
      border:1px solid var(--border);
      padding:.55rem .9rem; border-radius:.75rem;
      background: rgba(255,255,255,.06);
      transition: transform .04s ease, opacity .2s ease, background .2s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: scale(.98); }
    .btn-primary{ background: color-mix(in srgb, var(--brand) 85%, #000 15%); border-color: color-mix(in srgb, var(--brand) 65%, #000 35%); }
    .btn-primary:hover{ opacity:.95; }

    .kpi{ border-right: 4px solid transparent; }
    .kpi.good{ border-right-color: var(--good); }
    .kpi.bad{ border-right-color: var(--bad); }

    .chip{ border:1px solid var(--border); border-radius:999px; padding:2px 10px; font-size:.75rem; color: var(--muted); }
    .toast{ position:fixed; left:16px; bottom:16px; z-index:9999; width:min(420px, calc(100vw - 32px)); }
    .toast .item{ display:flex; gap:10px; align-items:flex-start; padding:12px 14px; border-radius:14px; border:1px solid var(--border); background:rgba(0,0,0,.35); backdrop-filter: blur(10px); margin-top:10px; }
    .toast .title{ font-weight:800; }
    .toast .msg{ color: var(--muted); font-size:.9rem; margin-top:2px; }

    /* Colored inputs for start/bought/spent */
    .inp-start{ color: var(--start) !important; background: color-mix(in srgb, var(--start) 10%, transparent) !important; border-color: color-mix(in srgb, var(--start) 25%, var(--border)) !important; font-weight:800; }
    .inp-buy{ color: var(--buy) !important; background: color-mix(in srgb, var(--buy) 10%, transparent) !important; border-color: color-mix(in srgb, var(--buy) 25%, var(--border)) !important; font-weight:800; }
    .inp-spent{ color: var(--spent) !important; background: color-mix(in srgb, var(--spent) 10%, transparent) !important; border-color: color-mix(in srgb, var(--spent) 25%, var(--border)) !important; font-weight:800; }

    /* Mobile tweaks */
    @media (max-width: 768px){
      .tableWrap{ font-size:13px; }
      input.table-input{ width:76px !important; padding:4px !important; font-size:12px; }
      .name-input{ width:140px !important; }
      .desc-input{ width:150px !important; }
    }

    /* Modal */
    .modalBack{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9998; }
    .modalBack.show{ display:flex; }
    .modal{ width:min(960px, calc(100vw - 24px)); max-height: calc(100vh - 24px); overflow:auto; border-radius:18px; }
  </style>
</head>

<body data-theme="midnight" class="min-h-screen">
  <!-- Topbar -->
  <div class="sticky top-0 z-40">
    <div class="glass">
      <div class="max-w-7xl mx-auto px-4 md:px-6 py-3 flex items-center gap-3 justify-between">
        <div class="flex items-center gap-3">
          <button id="btnMobileMenu" class="btn md:hidden" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fa-solid fa-bars"></i></button>
          <div class="w-11 h-11 rounded-2xl flex items-center justify-center" style="background:color-mix(in srgb, var(--brand) 80%, #000 20%);">
            <i class="fa-solid fa-cloud text-white text-xl"></i>
          </div>
          <div>
            <div class="flex items-center gap-2">
              <h1 id="appTitle" class="text-base md:text-lg font-black">Ù…Ø®Ø²Ù† Ø¯. Ø«Ø§Ø¦Ø±</h1>
              <span id="modeBadge" class="badge text-xs">Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</span>
            </div>
            <div class="flex items-center gap-2 text-xs">
              <span id="syncStatus" class="chip"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
              <span class="text-slate-500">|</span>
              <span id="userDisplay" class="text-slate-400 italic">...</span>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnTheme" class="btn" title="Ø«ÙŠÙ…"><i class="fa-solid fa-palette"></i></button>
          <button id="btnSettings" class="btn" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"><i class="fa-solid fa-sliders"></i></button>
          <button id="btnExport" class="btn" title="ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„"><i class="fa-solid fa-file-excel"></i></button>
          <button id="btnDownload" class="btn btn-primary text-white" title="ØªØ­Ù…ÙŠÙ„ HTML"><i class="fa-solid fa-download"></i></button>

          <button id="btnAdmin" class="btn" title="ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†"><i class="fa-solid fa-user-shield"></i></button>
          <button id="btnLogout" class="btn hidden" title="Ø®Ø±ÙˆØ¬"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 md:px-6 py-5">
    <div class="grid grid-cols-12 gap-4">
      <!-- Sidebar -->
      <aside id="sidebar" class="col-span-12 md:col-span-3 lg:col-span-3 glass rounded-2xl p-4 hidden md:block">
        <div class="flex items-center justify-between">
          <div class="font-black">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
          <span class="chip" id="kpiUpdated">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ...</span>
        </div>

        <div class="mt-4 space-y-2">
          <button class="btn w-full text-right" data-view="inventory"><i class="fa-solid fa-boxes-stacked ml-2"></i> Ø§Ù„Ù…Ø®Ø²Ù†</button>
          <button class="btn w-full text-right" data-view="reports"><i class="fa-solid fa-chart-line ml-2"></i> ØªÙ‚Ø§Ø±ÙŠØ± Ø³Ø±ÙŠØ¹Ø©</button>
          <button class="btn w-full text-right" data-view="about"><i class="fa-solid fa-circle-info ml-2"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
        </div>

        <div class="mt-4 solid rounded-2xl p-3">
          <div class="text-sm font-black mb-2">Ø¨Ø­Ø« ÙˆÙÙ„ØªØ±Ø©</div>
          <input id="searchBox" class="w-full p-2 rounded-xl text-sm" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØµÙ..." />
          <div class="grid grid-cols-2 gap-2 mt-2">
            <select id="filterStock" class="w-full p-2 rounded-xl text-sm">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="low">Ù†ÙˆØ§Ù‚Øµ ÙÙ‚Ø·</option>
              <option value="ok">Ù…ØªÙˆÙØ± ÙÙ‚Ø·</option>
            </select>
            <select id="sortBy" class="w-full p-2 rounded-xl text-sm">
              <option value="order">Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨</option>
              <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
              <option value="remaining">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</option>
              <option value="value">Ø§Ù„Ù‚ÙŠÙ…Ø©</option>
            </select>
          </div>
        </div>

        <div class="mt-4 solid rounded-2xl p-3">
          <div class="text-sm font-black mb-2">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
          <label class="flex items-center justify-between text-sm">
            <span class="text-slate-300">Ø­Ø¯ Ø§Ù„Ù†Ù‚Øµ</span>
            <input id="lowThreshold" type="number" step="1" class="w-20 p-2 rounded-xl text-center" />
          </label>
          <label class="flex items-center justify-between text-sm mt-2">
            <span class="text-slate-300">Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©</span>
            <input id="currency" type="text" class="w-20 p-2 rounded-xl text-center" />
          </label>
          <div class="text-xs text-slate-400 mt-2">ÙŠÙ‚Ø¯Ø± Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ®Ù„ÙŠÙ‡Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´ØªØ±ÙƒØ© Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©.</div>
        </div>
      </aside>

      <!-- Main -->
      <main class="col-span-12 md:col-span-9 lg:col-span-9 space-y-4">
        <!-- KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="glass rounded-2xl p-4 kpi">
            <div id="lblTotalValue" class="text-[11px] md:text-xs" style="color:var(--muted);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</div>
            <div id="totalValue" class="text-sm md:text-lg font-black" style="color:var(--brand);">0</div>
          </div>
          <div class="glass rounded-2xl p-4 kpi">
            <div id="lblTotalItems" class="text-[11px] md:text-xs" style="color:var(--muted);">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</div>
            <div id="totalItems" class="text-sm md:text-lg font-black">0</div>
          </div>
          <div class="glass rounded-2xl p-4 kpi bad">
            <div id="lblLowStock" class="text-[11px] md:text-xs" style="color:var(--muted);">Ù†ÙˆØ§Ù‚Øµ</div>
            <div id="lowStockCount" class="text-sm md:text-lg font-black" style="color:var(--bad);">0</div>
          </div>
          <div class="glass rounded-2xl p-4 kpi good">
            <div id="lblTotalSpent" class="text-[11px] md:text-xs" style="color:var(--muted);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ</div>
            <div id="totalSpent" class="text-sm md:text-lg font-black" style="color:var(--good);">0</div>
          </div>
        </div>

        <!-- Add Form (admin only enabled) -->
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="font-black">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</div>
            <div class="chip" id="adminHint">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ ÙƒØ£Ø¯Ù…Ù† Ø­ØªÙ‰ ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„</div>
          </div>

          <form id="addForm" class="grid grid-cols-2 md:grid-cols-6 gap-3">
            <div class="col-span-2 md:col-span-2">
              <input id="name" class="w-full p-2 rounded-xl text-sm" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©..." required />
            </div>
            <div class="col-span-2 md:col-span-2">
              <input id="desc" class="w-full p-2 rounded-xl text-sm" placeholder="Ø§Ù„ÙˆØµÙ..." />
            </div>
            <div>
              <input id="start" type="number" step="any" class="w-full p-2 rounded-xl text-sm inp-start" placeholder="Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" />
            </div>
            <div>
              <input id="cost" type="number" step="any" class="w-full p-2 rounded-xl text-sm" placeholder="Ø³Ø¹Ø± CC" />
            </div>

            <div class="col-span-2 md:col-span-6">
              <button id="btnAdd" type="submit" class="btn btn-primary w-full text-white font-black">
                Ø¥Ø¶Ø§ÙØ© <i class="fa-solid fa-plus mr-1"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- Table -->
        <div class="glass rounded-2xl overflow-hidden shadow-2xl">
          <div class="flex items-center justify-between px-4 py-3 border-b" style="border-color:var(--border);">
            <div class="font-black">Ø§Ù„Ù…ÙˆØ§Ø¯</div>
            <div class="flex items-center gap-2 text-xs">
              <span class="chip">Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØºÙŠÙŠØ±: <i class="fa-solid fa-grip-vertical"></i></span>
              <span class="chip" id="rowCount">0 ØµÙ</span>
            </div>
          </div>

          <div class="overflow-x-auto tableWrap">
            <table class="w-full text-right border-collapse">
              <thead>
                <tr class="border-b" style="border-color:var(--border);">
                  <th class="p-3 text-center w-8">#</th>
                  <th class="p-3">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                  <th class="p-3">Ø§Ù„ÙˆØµÙ</th>
                  <th class="p-3 text-center">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                  <th class="p-3 text-center">Ù…Ø´ØªØ±ÙŠØ§Øª</th>
                  <th class="p-3 text-center">Ù…ØµØ±ÙˆÙ</th>
                  <th class="p-3 text-center">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                  <th class="p-3 text-center">Ø³Ø¹Ø± CC</th>
                  <th class="p-3 text-center">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                  <th class="p-3 text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th class="p-3 text-center">Ø­Ø°Ù</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>

          <div id="emptyState" class="p-6 text-center hidden">
            <div class="text-3xl mb-2">ğŸ“¦</div>
            <div class="font-black">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
            <div class="text-sm mt-1" style="color:var(--muted);">Ø¥Ø°Ø§ Ø£Ù†Øª Ø§Ù„Ø£Ø¯Ù…Ù†ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯.</div>
          </div>
        </div>

        <!-- Reports -->
        <div id="reports" class="glass rounded-2xl p-4 hidden">
          <div class="font-black mb-3">ØªÙ‚Ø§Ø±ÙŠØ± Ø³Ø±ÙŠØ¹Ø©</div>
          <div class="grid md:grid-cols-2 gap-3">
            <div class="solid rounded-2xl p-4">
              <div class="text-sm font-black mb-2">Ø£Ø¹Ù„Ù‰ 5 Ù…ÙˆØ§Ø¯ Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø©</div>
              <div id="topValueList" class="text-sm" style="color:var(--muted);"></div>
            </div>
            <div class="solid rounded-2xl p-4">
              <div class="text-sm font-black mb-2">Ù†ÙˆØ§Ù‚Øµ (Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¯)</div>
              <div id="lowList" class="text-sm" style="color:var(--muted);"></div>
            </div>
          </div>
        </div>

        <!-- About -->
        <div id="about" class="glass rounded-2xl p-4 hidden">
          <div class="font-black mb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
          <div class="text-sm" style="color:var(--muted); line-height:1.8;">
            - Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.<br/>
            - Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø· (Email/Password).<br/>
            - ÙƒÙ„ ØªØºÙŠÙŠØ± ÙŠØªØ²Ø§Ù…Ù† ÙÙˆØ±Ø§Ù‹ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„Ø­Ø§Ø³Ø¨Ø© Ø¹Ø¨Ø± Firestore.<br/>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast" id="toast"></div>

  <!-- Modal: Admin Login -->
  <div id="modalLoginBack" class="modalBack">
    <div class="glass modal p-5">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-lg"><i class="fa-solid fa-user-shield ml-2"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</div>
        <button class="btn" onclick="UI.closeLogin()"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="solid rounded-2xl p-4">
          <div class="font-black mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
          <div class="text-sm mb-3" style="color:var(--muted);">Ø§Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø§Ø¨ Email/Password Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firebase Auth.</div>

          <input id="adminEmail" type="email" class="w-full p-2 rounded-xl text-sm mb-2" placeholder="admin@email.com" />
          <input id="adminPass" type="password" class="w-full p-2 rounded-xl text-sm mb-3" placeholder="Password" />

          <button id="btnDoLogin" class="btn btn-primary text-white w-full font-black">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div class="solid rounded-2xl p-4">
          <div class="font-black mb-2">Ù…Ù‡Ù… Ù„Ù„Ø£Ù…Ø§Ù† âœ…</div>
          <div class="text-sm" style="color:var(--muted); line-height:1.8;">
            Ø±Ø§Ø­ Ù†Ø®Ù„ÙŠ Firestore Rules ØªØ®Ù„ÙŠ:<br/>
            - <b>read: true</b><br/>
            - <b>write: ÙÙ‚Ø· UID Ø§Ù„Ø£Ø¯Ù…Ù†</b><br/><br/>
            ÙŠØ¹Ù†ÙŠ Ø­ØªÙ‰ Ù„Ùˆ Ø£Ø­Ø¯ ÙØªØ­ Ø§Ù„ÙƒÙˆØ¯ØŒ Ù…Ø§ ÙŠÙƒØ¯Ø± ÙŠÙƒØªØ¨ Ø¨Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Settings -->
  <div id="modalSettingsBack" class="modalBack">
    <div class="glass modal p-5">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-lg"><i class="fa-solid fa-sliders ml-2"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        <button class="btn" onclick="UI.closeSettings()"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="solid rounded-2xl p-4">
          <div class="font-black mb-2">ÙˆØ§Ø¬Ù‡Ø© ÙˆØ«ÙŠÙ…Ø§Øª</div>

          <label class="text-sm block mb-2" style="color:var(--muted);">Ø§Ù„Ø«ÙŠÙ…</label>
          <select id="themeSelect" class="w-full p-2 rounded-xl text-sm mb-4">
            <option value="midnight">Midnight</option>
            <option value="arctic">Arctic</option>
            <option value="lavender">Lavender</option>
            <option value="emerald">Emerald</option>
            <option value="sunset">Sunset</option>
            <option value="slateLight">Slate Light</option>
            <option value="coffee">Coffee</option>
            <option value="mono">Mono</option>
          </select>

          <label class="text-sm block mb-2" style="color:var(--muted);">ÙƒØ«Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„</label>
          <select id="density" class="w-full p-2 rounded-xl text-sm">
            <option value="compact">Compact</option>
            <option value="normal">Normal</option>
          </select>
        </div>

        <div class="solid rounded-2xl p-4">
          <div class="font-black mb-2">Ù†ØµÙˆØµ ÙˆØ¹Ù†Ø§ÙˆÙŠÙ† (Ù„Ù„Ø£Ø¯Ù…Ù†)</div>
          <div class="text-sm mb-3" style="color:var(--muted);">ØªØªØ®Ø²Ù† Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØªØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹.</div>

          <input id="setTitle" class="w-full p-2 rounded-xl text-sm mb-2" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" />
          <div class="grid grid-cols-2 gap-2">
            <input id="setLblTotalValue" class="w-full p-2 rounded-xl text-sm" placeholder="Label: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©" />
            <input id="setLblTotalItems" class="w-full p-2 rounded-xl text-sm" placeholder="Label: Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯" />
            <input id="setLblLowStock" class="w-full p-2 rounded-xl text-sm" placeholder="Label: Ù†ÙˆØ§Ù‚Øµ" />
            <input id="setLblTotalSpent" class="w-full p-2 rounded-xl text-sm" placeholder="Label: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ" />
          </div>

          <button id="btnSaveCloudSettings" class="btn btn-primary text-white w-full font-black mt-3">
            Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInAnonymously,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      onSnapshot,
      query,
      writeBatch,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // =========================
    // 1) Firebase CONFIG  âœ… (ØºÙŠÙ‘Ø±Ù‡ Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ)
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyC_KaWOZVWJ5WvVhUjiz58dx6d6sWH1EZQ",
      authDomain: "clinic-storage.firebaseapp.com",
      projectId: "clinic-storage",
      storageBucket: "clinic-storage.firebasestorage.app",
      messagingSenderId: "284636281654",
      appId: "1:284636281654:web:aa19cd577c4efda5d21197"
    };

    // Shared appId for same data across devices
    const appId = "clinic-storage";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // 2) State
    // =========================
    let currentUser = null;
    let isAdmin = false;
    let inventory = [];
    let sortableInited = false;

    // Local settings
    const LS_KEY = "clinic_storage_ui_v2";
    const local = loadLocalSettings();
    applyLocalSettings(local);

    // Cloud settings doc (public read; admin write)
    const cloudSettingsRef = doc(db, "artifacts", appId, "public", "data", "settings", "ui");

    // =========================
    // 3) Helpers / UI
    // =========================
    const $ = (id) => document.getElementById(id);
    const esc = (v) => String(v ?? "").replace(/"/g, "&quot;");

    function toast(type, title, msg){
      const box = $("toast");
      const icon = type==="ok" ? "fa-circle-check" : type==="warn" ? "fa-triangle-exclamation" : "fa-circle-xmark";
      const color = type==="ok" ? "var(--good)" : type==="warn" ? "var(--warn)" : "var(--bad)";
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div style="margin-top:2px;color:${color};"><i class="fa-solid ${icon}"></i></div>
        <div>
          <div class="title">${esc(title)}</div>
          <div class="msg">${esc(msg||"")}</div>
        </div>
      `;
      box.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, 3500);
      setTimeout(()=>{ el.remove(); }, 4200);
    }

    function setStatus(state, text){
      const s = $("syncStatus");
      if(!s) return;
      if(state==="online"){
        s.className = "chip";
        s.innerHTML = `<i class="fa-solid fa-circle text-[8px]" style="color:var(--good)"></i> ${text||"Ù…ØªØµÙ„"}`;
      }else if(state==="offline"){
        s.className = "chip";
        s.innerHTML = `<i class="fa-solid fa-circle text-[8px]" style="color:var(--bad)"></i> ${text||"Offline"}`;
      }else{
        s.className = "chip";
        s.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${text||"Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„..."}`;
      }
    }

    function setAdminUI(){
      $("modeBadge").textContent = isAdmin ? "Admin" : "Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·";
      $("adminHint").textContent = isAdmin ? "Ø£Ù†Øª Ø£Ø¯Ù…Ù†: Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ØªØ§Ø­Ø©" : "Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ ÙƒØ£Ø¯Ù…Ù† Ø­ØªÙ‰ ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„";
      $("btnAdmin").classList.toggle("hidden", isAdmin);
      $("btnLogout").classList.toggle("hidden", !isAdmin);

      // enable/disable add form
      $("name").disabled = !isAdmin;
      $("desc").disabled = !isAdmin;
      $("start").disabled = !isAdmin;
      $("cost").disabled = !isAdmin;
      $("btnAdd").disabled = !isAdmin;
      $("btnAdd").style.opacity = isAdmin ? "1" : ".55";
    }

    // Sidebar view switching
    function showView(view){
      const reports = $("reports");
      const about = $("about");
      reports.classList.toggle("hidden", view !== "reports");
      about.classList.toggle("hidden", view !== "about");
    }

    // =========================
    // 4) Collections/Refs
    // =========================
    const invCol = () => collection(db, "artifacts", appId, "public", "data", "inventory");

    // =========================
    // 5) Auth logic (Anonymous for guests + Email/Pass for admin)
    // =========================
    async function initGuestAuth(){
      try{
        await signInAnonymously(auth);
      }catch(err){
        console.error(err);
        setStatus("offline", err?.code || "Auth error");
        toast("err","ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„","ØªØ£ÙƒØ¯ Anonymous Auth Ù…ÙØ¹Ù„ + Firestore Rules.");
      }
    }

    async function adminLogin(email, pass){
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        toast("ok","ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„","Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø£Ø¯Ù…Ù† âœ…");
        UI.closeLogin();
      }catch(err){
        console.error(err);
        toast("err","ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„", err?.code || err?.message || "Login error");
      }
    }

    async function logout(){
      try{
        await signOut(auth);
        toast("ok","ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬","Ø±Ø¬Ø¹Ù†Ø§ Ù„Ù„ÙˆØ¶Ø¹ Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·");
        // After signOut, auto guest auth
        await initGuestAuth();
      }catch(e){
        console.error(e);
      }
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;
      if(!user){
        isAdmin = false;
        setAdminUI();
        setStatus("connecting","Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...");
        return;
      }

      // Admin detection: if NOT anonymous => treat as admin
      isAdmin = !user.isAnonymous;
      setAdminUI();

      $("userDisplay").textContent = `UID: ${user.uid.substring(0,8)}${isAdmin ? " (admin)" : ""}`;
      setStatus("online", "Ù…ØªØµÙ„ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹");

      // Start realtime (once)
      startRealtime();
      listenCloudSettings();
    });

    // =========================
    // 6) Firestore realtime
    // =========================
    let unsubInv = null;
    function startRealtime(){
      if(unsubInv) return;
      const q = query(invCol());
      unsubInv = onSnapshot(q, (snap)=>{
        inventory = snap.docs.map(d=>({id:d.id, ...d.data()}))
          .sort((a,b)=>(a.order||0)-(b.order||0));
        render();
        $("kpiUpdated").textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + new Date().toLocaleTimeString("ar-IQ");
      }, (err)=>{
        console.error(err);
        setStatus("offline", err?.code || "Firestore error");
        toast("err","Firestore","ØªØ£ÙƒØ¯ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Rules ØµØ­ÙŠØ­Ø©.");
      });
    }

    function listenCloudSettings(){
      onSnapshot(cloudSettingsRef, (snap)=>{
        if(!snap.exists()) return;
        const s = snap.data() || {};
        applyCloudSettings(s);
      });
    }

    // =========================
    // 7) Admin-only write ops
    // =========================
    window.updateField = async (id, field, value)=>{
      if(!isAdmin) return toast("warn","Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·","Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·");
      const isText = field==="name" || field==="desc";
      const val = isText ? (value ?? "") : (parseFloat(value) || 0);
      try{
        await updateDoc(doc(db, "artifacts", appId, "public", "data", "inventory", id), { [field]: val });
      }catch(err){
        console.error(err);
        toast("err","ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«", err?.code || "Update error");
      }
    };

    window.deleteItem = async (id)=>{
      if(!isAdmin) return toast("warn","Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·","Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·");
      if(!confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) return;
      try{
        await deleteDoc(doc(db, "artifacts", appId, "public", "data", "inventory", id));
        toast("ok","ØªÙ… Ø§Ù„Ø­Ø°Ù","");
      }catch(err){
        console.error(err);
        toast("err","ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù", err?.code || "Delete error");
      }
    };

    // Add
    $("addForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!isAdmin) return toast("warn","Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·","Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·");

      const name = ($("name").value||"").trim();
      const desc = ($("desc").value||"").trim();
      const start = parseFloat($("start").value)||0;
      const cost = parseFloat($("cost").value)||0;
      if(!name) return;

      const data = { name, desc, start, bought:0, spent:0, cost, order: inventory.length, createdAt: Date.now() };

      try{
        await addDoc(invCol(), data);
        e.target.reset();
        toast("ok","ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©","");
      }catch(err){
        console.error(err);
        toast("err","ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©", err?.code || "Add error");
      }
    });

    // Sort order (admin only)
    function ensureSortable(){
      if(sortableInited) return;
      if(typeof Sortable === "undefined") return;

      Sortable.create($("tableBody"), {
        handle: ".handle",
        animation: 150,
        onEnd: async ()=>{
          if(!isAdmin) return toast("warn","Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·","Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·");
          try{
            const batch = writeBatch(db);
            document.querySelectorAll("#tableBody tr").forEach((row, idx)=>{
              const id = row.getAttribute("data-id");
              if(id) batch.update(doc(db, "artifacts", appId, "public", "data", "inventory", id), { order: idx });
            });
            await batch.commit();
            toast("ok","ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨","");
          }catch(err){
            console.error(err);
            toast("err","ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨", err?.code || "Sort error");
          }
        }
      });

      sortableInited = true;
    }

    // =========================
    // 8) Render + Filters
    // =========================
    function getFiltered(){
      const q = ($("searchBox").value||"").trim().toLowerCase();
      const stock = $("filterStock").value;
      const sortBy = $("sortBy").value;
      const th = Number(local.lowThreshold ?? 2);

      let rows = inventory.filter(it=>{
        const name = String(it.name||"").toLowerCase();
        const desc = String(it.desc||"").toLowerCase();
        const okSearch = !q || name.includes(q) || desc.includes(q);

        const remaining = (Number(it.start)||0) + (Number(it.bought)||0) - (Number(it.spent)||0);
        const isLow = remaining <= th;

        const okStock = stock==="all" || (stock==="low" && isLow) || (stock==="ok" && !isLow);
        return okSearch && okStock;
      });

      rows.sort((a,b)=>{
        if(sortBy==="name") return String(a.name||"").localeCompare(String(b.name||""), "ar");
        if(sortBy==="remaining"){
          const ra = (Number(a.start)||0)+(Number(a.bought)||0)-(Number(a.spent)||0);
          const rb = (Number(b.start)||0)+(Number(b.bought)||0)-(Number(b.spent)||0);
          return rb-ra;
        }
        if(sortBy==="value"){
          const va = ((Number(a.start)||0)+(Number(a.bought)||0)-(Number(a.spent)||0))*(Number(a.cost)||0);
          const vb = ((Number(b.start)||0)+(Number(b.bought)||0)-(Number(b.spent)||0))*(Number(b.cost)||0);
          return vb-va;
        }
        return (a.order||0)-(b.order||0);
      });

      return rows;
    }

    function render(){
      const body = $("tableBody");
      const th = Number(local.lowThreshold ?? 2);
      const cur = local.currency ?? "Ø¯.Ø¹";

      const rows = getFiltered();
      body.innerHTML = "";

      $("rowCount").textContent = rows.length + " ØµÙ";

      let totalVal=0, totalSpent=0, lowCount=0;

      for(const item of rows){
        const start = Number(item.start)||0;
        const bought = Number(item.bought)||0;
        const spent = Number(item.spent)||0;
        const cost = Number(item.cost)||0;
        const remaining = (start+bought)-spent;
        const value = remaining*cost;

        totalVal += value;
        totalSpent += spent;
        if(remaining <= th) lowCount++;

        const statusText = remaining <= th ? "Ù†Ù‚Øµ" : "Ù…ØªÙˆÙØ±";
        const statusClass = remaining <= th ? "text-red-300 font-black" : "text-emerald-300 font-black";

        const tr = document.createElement("tr");
        tr.className = "border-b hover:bg-white/5 transition-colors";
        tr.style.borderColor = "var(--border)";
        tr.setAttribute("data-id", item.id);

        const ro = !isAdmin ? "disabled" : "";
        const delDisabled = !isAdmin ? "opacity:.35;pointer-events:none" : "";

        tr.innerHTML = `
          <td class="p-2 text-center"><i class="fa-solid fa-grip-vertical handle"></i></td>

          <td class="p-2">
            <input ${ro} class="name-input w-full p-2 rounded-xl text-sm"
              value="${esc(item.name)}"
              onblur="updateField('${item.id}','name',this.value)" />
          </td>

          <td class="p-2">
            <input ${ro} class="desc-input w-full p-2 rounded-xl text-sm"
              value="${esc(item.desc)}"
              onblur="updateField('${item.id}','desc',this.value)" />
          </td>

          <td class="p-2 text-center">
            <input ${ro} type="number" step="any" class="table-input w-20 p-2 rounded-xl text-center inp-start"
              value="${start}"
              onchange="updateField('${item.id}','start',this.value)" />
          </td>

          <td class="p-2 text-center">
            <input ${ro} type="number" step="any" class="table-input w-20 p-2 rounded-xl text-center inp-buy"
              value="${bought}"
              onchange="updateField('${item.id}','bought',this.value)" />
          </td>

          <td class="p-2 text-center">
            <input ${ro} type="number" step="any" class="table-input w-20 p-2 rounded-xl text-center inp-spent"
              value="${spent}"
              onchange="updateField('${item.id}','spent',this.value)" />
          </td>

          <td class="p-2 text-center font-black ${remaining <= th ? "text-red-300" : ""}">
            ${remaining}
          </td>

          <td class="p-2 text-center">
            <input ${ro} type="number" step="any" class="table-input w-24 p-2 rounded-xl text-center"
              value="${cost}"
              onchange="updateField('${item.id}','cost',this.value)" />
          </td>

          <td class="p-2 text-center font-black" style="color:var(--brand);">
            ${Number.isFinite(value) ? value.toLocaleString("ar-IQ") : "0"} ${esc(cur)}
          </td>

          <td class="p-2 text-center ${statusClass}">${statusText}</td>

          <td class="p-2 text-center" style="${delDisabled}">
            <button class="btn" onclick="deleteItem('${item.id}')" title="Ø­Ø°Ù">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        `;

        body.appendChild(tr);
      }

      $("emptyState").classList.toggle("hidden", rows.length !== 0);

      $("totalValue").textContent = totalVal.toLocaleString("ar-IQ") + " " + cur;
      $("totalItems").textContent = inventory.length.toLocaleString("ar-IQ");
      $("lowStockCount").textContent = lowCount.toLocaleString("ar-IQ");
      $("totalSpent").textContent = totalSpent.toLocaleString("ar-IQ");

      renderReports();

      ensureSortable();
    }

    function renderReports(){
      const th = Number(local.lowThreshold ?? 2);
      const cur = local.currency ?? "Ø¯.Ø¹";

      const all = [...inventory];
      const withValue = all.map(i=>{
        const remaining = (Number(i.start)||0)+(Number(i.bought)||0)-(Number(i.spent)||0);
        const value = remaining*(Number(i.cost)||0);
        return { ...i, remaining, value };
      });

      const top = withValue.sort((a,b)=>b.value-a.value).slice(0,5);
      $("topValueList").innerHTML = top.length
        ? top.map(x=>`<div class="flex justify-between py-1"><span>${esc(x.name||"")}</span><span class="font-black">${x.value.toLocaleString("ar-IQ")} ${esc(cur)}</span></div>`).join("")
        : `<div>Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;

      const low = withValue.filter(x=>x.remaining<=th).sort((a,b)=>a.remaining-b.remaining).slice(0,10);
      $("lowList").innerHTML = low.length
        ? low.map(x=>`<div class="flex justify-between py-1"><span>${esc(x.name||"")}</span><span class="font-black" style="color:var(--bad)">${x.remaining}</span></div>`).join("")
        : `<div>Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;
    }

    // Re-render on filter changes
    ["searchBox","filterStock","sortBy"].forEach(id=>{
      $(id).addEventListener("input", ()=>render());
      $(id).addEventListener("change", ()=>render());
    });

    // =========================
    // 9) Local settings (theme, threshold, currency, density)
    // =========================
    function loadLocalSettings(){
      try{
        return JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      }catch{
        return {};
      }
    }
    function saveLocalSettings(){
      localStorage.setItem(LS_KEY, JSON.stringify(local));
    }
    function applyLocalSettings(s){
      // defaults
      if(s.theme) document.body.setAttribute("data-theme", s.theme);
      if(s.density==="compact"){
        document.documentElement.style.setProperty("--rowPad","6px");
      }
      // sidebar quick inputs
      if($("lowThreshold")) $("lowThreshold").value = s.lowThreshold ?? 2;
      if($("currency")) $("currency").value = s.currency ?? "Ø¯.Ø¹";
    }

    // Sidebar quick setting updates
    $("lowThreshold").value = local.lowThreshold ?? 2;
    $("currency").value = local.currency ?? "Ø¯.Ø¹";

    $("lowThreshold").addEventListener("input", ()=>{
      local.lowThreshold = Number($("lowThreshold").value || 2);
      saveLocalSettings();
      render();
    });
    $("currency").addEventListener("input", ()=>{
      local.currency = $("currency").value || "Ø¯.Ø¹";
      saveLocalSettings();
      render();
    });

    // =========================
    // 10) Cloud settings (admin only save)
    // =========================
    function applyCloudSettings(s){
      if(s.title) $("appTitle").textContent = s.title;
      if(s.lblTotalValue) $("lblTotalValue").textContent = s.lblTotalValue;
      if(s.lblTotalItems) $("lblTotalItems").textContent = s.lblTotalItems;
      if(s.lblLowStock) $("lblLowStock").textContent = s.lblLowStock;
      if(s.lblTotalSpent) $("lblTotalSpent").textContent = s.lblTotalSpent;

      // Put into settings modal inputs
      $("setTitle").value = s.title || "";
      $("setLblTotalValue").value = s.lblTotalValue || "";
      $("setLblTotalItems").value = s.lblTotalItems || "";
      $("setLblLowStock").value = s.lblLowStock || "";
      $("setLblTotalSpent").value = s.lblTotalSpent || "";
    }

    async function saveCloudSettings(){
      if(!isAdmin) return toast("warn","Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·","Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·");

      const payload = {
        title: $("setTitle").value || "Ù…Ø®Ø²Ù† Ø¯. Ø«Ø§Ø¦Ø±",
        lblTotalValue: $("setLblTotalValue").value || "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©",
        lblTotalItems: $("setLblTotalItems").value || "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯",
        lblLowStock: $("setLblLowStock").value || "Ù†ÙˆØ§Ù‚Øµ",
        lblTotalSpent: $("setLblTotalSpent").value || "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ",
        updatedAt: Date.now(),
        updatedBy: currentUser?.uid || null
      };

      try{
        await setDoc(cloudSettingsRef, payload, { merge:true });
        toast("ok","ØªÙ… Ø§Ù„Ø­ÙØ¸","Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§");
      }catch(err){
        console.error(err);
        toast("err","ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", err?.code || "Save error");
      }
    }

    $("btnSaveCloudSettings").addEventListener("click", saveCloudSettings);

    // =========================
    // 11) Theme + Settings modal
    // =========================
    const UI = window.UI = {
      openLogin(){ $("modalLoginBack").classList.add("show"); },
      closeLogin(){ $("modalLoginBack").classList.remove("show"); },
      openSettings(){
        $("modalSettingsBack").classList.add("show");
        // sync UI
        $("themeSelect").value = local.theme || document.body.getAttribute("data-theme") || "midnight";
        $("density").value = local.density || "normal";
      },
      closeSettings(){ $("modalSettingsBack").classList.remove("show"); }
    };

    $("btnAdmin").addEventListener("click", UI.openLogin);
    $("btnSettings").addEventListener("click", UI.openSettings);

    $("btnLogout").addEventListener("click", logout);

    $("btnDoLogin").addEventListener("click", ()=>{
      adminLogin($("adminEmail").value.trim(), $("adminPass").value);
    });

    $("btnTheme").addEventListener("click", ()=>{
      UI.openSettings();
      $("themeSelect").focus();
    });

    $("themeSelect").addEventListener("change", ()=>{
      local.theme = $("themeSelect").value;
      document.body.setAttribute("data-theme", local.theme);
      saveLocalSettings();
      toast("ok","ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø«ÙŠÙ…", local.theme);
    });

    $("density").addEventListener("change", ()=>{
      local.density = $("density").value;
      saveLocalSettings();
      toast("ok","ØªÙ…", "ØªØºÙŠØ±Øª ÙƒØ«Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„");
    });

    // Sidebar mobile
    $("btnMobileMenu").addEventListener("click", ()=>{
      $("sidebar").classList.toggle("hidden");
    });

    // Sidebar buttons
    document.querySelectorAll("[data-view]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const v = btn.getAttribute("data-view");
        showView(v);
        if(window.innerWidth < 768) $("sidebar").classList.add("hidden");
      });
    });

    // =========================
    // 12) Export + Download
    // =========================
    $("btnExport").addEventListener("click", exportToExcel);
    $("btnDownload").addEventListener("click", downloadAppFile);

    function exportToExcel(){
      if(typeof XLSX === "undefined"){
        return toast("err","XLSX","Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥ÙƒØ³Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
      }
      const th = Number(local.lowThreshold ?? 2);
      const cur = local.currency ?? "Ø¯.Ø¹";

      const data = inventory.map(i=>{
        const start = Number(i.start)||0;
        const bought = Number(i.bought)||0;
        const spent = Number(i.spent)||0;
        const cost = Number(i.cost)||0;
        const remaining = (start+bought)-spent;
        const status = remaining <= th ? "Ù†Ù‚Øµ" : "Ù…ØªÙˆÙØ±";
        return {
          "Ø§Ù„Ù…Ø§Ø¯Ø©": i.name || "",
          "Ø§Ù„ÙˆØµÙ": i.desc || "",
          "Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©": start,
          "Ù…Ø´ØªØ±ÙŠØ§Øª": bought,
          "Ù…ØµØ±ÙˆÙ": spent,
          "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ": remaining,
          "Ø³Ø¹Ø± CC": cost,
          "Ø§Ù„Ù‚ÙŠÙ…Ø©": remaining*cost,
          "Ø§Ù„Ø¹Ù…Ù„Ø©": cur,
          "Ø§Ù„Ø­Ø§Ù„Ø©": status
        };
      });

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Inventory");
      XLSX.writeFile(wb, `Clinic_Storage_${new Date().toISOString().split("T")[0]}.xlsx`);
      toast("ok","ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±","Excel Ø¬Ø§Ù‡Ø² âœ…");
    }

    function downloadAppFile(){
      const content = document.documentElement.outerHTML;
      const blob = new Blob([content], { type: "text/html" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "index.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      toast("ok","ØªÙ…","ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù index.html");
    }

    // =========================
    // 13) Start
    // =========================
    setStatus("connecting","Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...");
    setAdminUI();
    await initGuestAuth();
  </script>
</body>
</html>
