<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, updateDoc, deleteDoc,
    doc, onSnapshot, query, writeBatch
  } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  // ✅ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC_KaWOZVWJ5WvVhUjiz58dx6d6sWH1EZQ",
    authDomain: "clinic-storage.firebaseapp.com",
    projectId: "clinic-storage",
    storageBucket: "clinic-storage.firebasestorage.app",
    messagingSenderId: "284636281654",
    appId: "1:284636281654:web:aa19cd577c4efda5d21197"
  };
  const appId = "clinic-storage";

  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);
  const esc = (v) => String(v ?? "").replace(/"/g, "&quot;");
  const loadJson = (k, fallback) => {
    try { return { ...fallback, ...(JSON.parse(localStorage.getItem(k) || "{}")) }; }
    catch { return { ...fallback }; }
  };
  const saveJson = (k, obj) => localStorage.setItem(k, JSON.stringify(obj));

  // ===== Settings =====
  let SETTINGS = loadJson("settings", { theme: "midnight", lowThreshold: 2, currency: "د.ع" });
  let TEXTS = loadJson("texts", {
    statusOk: "متوفر",
    statusLow: "نقص",
    colName: "المادة",
    colDesc: "الوصف",
    colStart: "البداية",
    colBought: "مشتريات",
    colSpent: "مصروف"
  });

  // ===== Admin Logic (Security Layer) =====
  const ADMIN_PASS_KEY = "admin_password_plain";
  const DEFAULT_PASS = "admin123";

  window.isAdmin = () => localStorage.getItem("admin_unlocked") === "1";
  
  window.openAdmin = () => {
    $("adminModal")?.classList.remove("hidden");
    $("adminPassword")?.focus();
  };

  window.adminLogin = () => {
    const pass = ($("adminPassword")?.value || "").trim();
    const stored = localStorage.getItem(ADMIN_PASS_KEY) || DEFAULT_PASS;
    if (pass === stored) {
      localStorage.setItem("admin_unlocked", "1");
      $("adminModal")?.classList.add("hidden");
      refreshAdminUI();
      renderTable(); // إعادة الرندر لتفعيل الأزرار
    } else {
      $("adminError")?.classList.remove("hidden");
    }
  };

  window.adminLogout = () => {
    localStorage.setItem("admin_unlocked", "0");
    refreshAdminUI();
    renderTable();
  };

  function refreshAdminUI() {
    const locked = !window.isAdmin();
    const form = $("addForm");
    if (form) {
      form.querySelectorAll("input,button").forEach(el => {
        el.disabled = locked;
        el.classList.toggle("opacity-50", locked);
        el.classList.toggle("cursor-not-allowed", locked);
      });
    }
  }

  // ===== Firebase Setup =====
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  let inventory = [];

  const invCol = () => collection(db, "artifacts", appId, "public", "data", "inventory");

  // ===== Core Functions =====
  async function initApp() {
    try {
      await signInAnonymously(auth);
      onAuthStateChanged(auth, (user) => {
        if (user) {
          $("syncStatus")?.classList.add("text-emerald-400");
          $("syncStatus").innerHTML = "● متصل سحابياً";
          startRealtimeSync();
        }
      });
    } catch (err) {
      console.error("Auth Error:", err);
      alert("فشل الاتصال بالسحابة");
    }
  }

  function startRealtimeSync() {
    onSnapshot(query(invCol()), (snap) => {
      // حماية: لا تقم بإعادة بناء الجدول إذا كان المستخدم يكتب الآن في حقل نصي
      const isTyping = document.activeElement && 
                       (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA");
      
      inventory = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                       .sort((a, b) => (a.order || 0) - (b.order || 0));
      
      if (!isTyping) {
        renderTable();
      }
    }, (err) => {
      console.error("Firestore Error:", err);
    });
  }

  window.updateField = async (id, field, value) => {
    if (!window.isAdmin()) return window.openAdmin();
    try {
      const isText = ["name", "desc"].includes(field);
      const val = isText ? value : (parseFloat(value) || 0);
      await updateDoc(doc(db, "artifacts", appId, "public", "data", "inventory", id), { [field]: val });
    } catch (err) {
      alert("حدث خطأ أثناء التحديث: " + err.message);
    }
  };

  window.deleteItem = async (id) => {
    if (!window.isAdmin()) return window.openAdmin();
    if (!confirm("هل أنت متأكد من الحذف نهائياً؟")) return;
    try {
      await deleteDoc(doc(db, "artifacts", appId, "public", "data", "inventory", id));
    } catch (err) {
      alert("فشل الحذف");
    }
  };

  function renderTable() {
    const body = $("tableBody");
    if (!body) return;

    body.innerHTML = "";
    let totals = { val: 0, spent: 0, low: 0 };

    inventory.forEach((item) => {
      const start = Number(item.start) || 0;
      const bought = Number(item.bought) || 0;
      const spent = Number(item.spent) || 0;
      const cost = Number(item.cost) || 0;
      const remaining = (start + bought) - spent;
      const rowValue = remaining * cost;

      totals.val += rowValue;
      totals.spent += spent;
      if (remaining <= SETTINGS.lowThreshold) totals.low++;

      const isLow = remaining <= SETTINGS.lowThreshold;
      const isAdmin = window.isAdmin();

      const tr = document.createElement("tr");
      tr.className = "border-b border-slate-800 hover:bg-slate-800/40 transition-colors";
      tr.innerHTML = `
        <td class="p-2 text-center"><i class="fas fa-grip-vertical handle text-slate-700 cursor-move"></i></td>
        <td class="p-2"><input type="text" value="${esc(item.name)}" onblur="updateField('${item.id}','name',this.value)" ${!isAdmin?'disabled':''} class="w-full bg-transparent border-none focus:ring-1 focus:ring-blue-500 font-bold rounded px-2"></td>
        <td class="p-2"><input type="text" value="${esc(item.desc)}" onblur="updateField('${item.id}','desc',this.value)" ${!isAdmin?'disabled':''} class="w-full bg-transparent border-none focus:ring-1 focus:ring-blue-500 rounded px-2"></td>
        <td class="p-2 text-center"><input type="number" value="${start}" onchange="updateField('${item.id}','start',this.value)" ${!isAdmin?'disabled':''} class="w-20 p-1 rounded text-center font-bold text-emerald-300 bg-emerald-500/10 border border-emerald-500/30"></td>
        <td class="p-2 text-center"><input type="number" value="${bought}" onchange="updateField('${item.id}','bought',this.value)" ${!isAdmin?'disabled':''} class="w-20 p-1 rounded text-center font-bold text-sky-300 bg-sky-500/10 border border-sky-500/30"></td>
        <td class="p-2 text-center"><input type="number" value="${spent}" onchange="updateField('${item.id}','spent',this.value)" ${!isAdmin?'disabled':''} class="w-20 p-1 rounded text-center font-bold text-orange-300 bg-orange-500/10 border border-orange-500/30"></td>
        <td class="p-2 text-center font-bold ${isLow ? 'text-red-400' : 'text-slate-200'}">${remaining}</td>
        <td class="p-2 text-center"><input type="number" value="${cost}" onchange="updateField('${item.id}','cost',this.value)" ${!isAdmin?'disabled':''} class="w-24 p-1 rounded text-center bg-slate-700/30 border border-slate-600"></td>
        <td class="p-2 text-center font-bold text-blue-400 text-xs">${rowValue.toLocaleString()}</td>
        <td class="p-2 text-center ${isLow ? 'text-red-400' : 'text-emerald-400'} font-bold">${isLow ? TEXTS.statusLow : TEXTS.statusOk}</td>
        <td class="p-2 text-center">
          ${isAdmin ? `<button onclick="deleteItem('${item.id}')" class="text-slate-500 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>` : ''}
        </td>
      `;
      body.appendChild(tr);
    });

    // تحديث البطاقات العلوية
    if($("totalValue")) $("totalValue").innerText = totals.val.toLocaleString() + " " + SETTINGS.currency;
    if($("lowStockCount")) $("lowStockCount").innerText = totals.low;
    if($("totalSpent")) $("totalSpent").innerText = totals.spent;
    if($("totalItems")) $("totalItems").innerText = inventory.length;
  }

  // ===== Excel Export =====
  window.exportToExcel = () => {
    if (typeof XLSX === "undefined") return alert("مكتبة Excel غير محملة");
    const data = inventory.map(i => ({
      [TEXTS.colName]: i.name,
      [TEXTS.colDesc]: i.desc,
      [TEXTS.colStart]: i.start,
      "المتبقي": (Number(i.start) + Number(i.bought)) - Number(i.spent),
      "القيمة": ((Number(i.start) + Number(i.bought)) - Number(i.spent)) * (Number(i.cost) || 0)
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventory");
    XLSX.writeFile(wb, `مخزن_${new Date().toLocaleDateString()}.xlsx`);
  };

  // ===== Start App =====
  document.addEventListener("DOMContentLoaded", () => {
    initApp();
    refreshAdminUI();
    
    $("addForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!window.isAdmin()) return window.openAdmin();
      
      const newItem = {
        name: $("name").value,
        desc: $("desc").value,
        start: parseFloat($("start").value) || 0,
        bought: 0,
        spent: 0,
        cost: parseFloat($("cost").value) || 0,
        order: inventory.length,
        createdAt: Date.now()
      };

      try {
        await addDoc(invCol(), newItem);
        $("addForm").reset();
      } catch (err) {
        alert("فشل إضافة المادة");
      }
    });
  });
</script>
